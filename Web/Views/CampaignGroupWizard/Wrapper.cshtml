@*
    Contains all partial views and sections for the creation of a new campaign group.
*@

<!-- Wrapper entity -->
<main>
    <!-- TODO Debug: remove this class -->
    <div class="dashboard-content">

        <!-- Contains all buttons for selecting our sections -->
        <ul id="selectors" class="nav">
            <li><button id="selectorAccount" data-progress="1" data-toggle="tab" data-target="#sectionAccount" class="btn text-white btn-main btn-blue mt-5">Account</button></li>
            <li><button id="selectorMarketing" data-progress="2" data-toggle="tab" data-target="#sectionMarketing" class="btn text-white btn-main btn-blue mt-5">Marketing</button></li>
            <li><button id="selectorTargeting" data-progress="3" data-toggle="tab" data-target="#sectionTargeting" class="btn text-white btn-main btn-blue mt-5">Targeting</button></li>
            <li><button id="selectorSchedule" data-progress="4" data-toggle="tab" data-target="#sectionSchedule" class="btn text-white btn-main btn-blue mt-5">Schedule</button></li>
            <li><button id="selectorAdGroups" data-progress="5" data-toggle="tab" data-target="#sectionAdGroups" class="btn text-white btn-main btn-blue mt-5">Ad Groups</button></li>
            <li><button id="selectorOverview" data-progress="6" data-toggle="tab" data-target="#sectionOverview" class="btn text-white btn-main btn-blue mt-5 clickToRefreshOverview">Overview</button></li>
        </ul>

        <!-- One giant form with fieldsets for each tab -->
        <form id="formWizard" asp-controller="CampaignGroupWizard" asp-action="SubmitForm" method="post">
            @{ var formModel = new CampaignGroupFormAllViewModel(); }
            <div class="tab-content">
                <div class="tab-pane active" id="sectionAccount"><partial name="_SectionAccount" model="formModel" /></div>
                <div class="tab-pane" id="sectionMarketing"><partial name="_SectionMarketing" model="formModel" /></div>
                <div class="tab-pane" id="sectionTargeting"><partial name="_SectionTargeting" model="formModel" /></div>
                <div class="tab-pane" id="sectionSchedule"><partial name="_SectionSchedule" model="formModel" /></div>
                <div class="tab-pane" id="sectionAdGroups"><partial name="_SectionAdGroups" model="formModel" /></div>
                <div class="tab-pane" id="sectionOverview"><partial name="_SectionOverview" model="formModel" /></div>
            </div>
        </form>

    </div>

</main>



@section Scripts {

    <!-- Import partial view with validation rules for each section -->
    <partial name="_ValidationRules" />

    <!-- Import ad group functionality -->
    <partial name="_SectionAdGroupsScripts" />

    <!-- Import overivew functionality -->
    <partial name="_SectionOverviewScripts" />

    <!-- Scripts for our campaign group wizard wrapper -->
    <script type="text/javascript">

        // Indicates our subform progress
        var progressIndex = 1;
        var maxProgress = 6;

        // Initialize our validator object
        setupValidatorDefaults();
        var validatorWizardCampaignGroup = $('#formWizard').validate();

        // Explicitly define all elements that have to be validated for each section
        var elementsAccount = [
            '.checkboxPublisher',
            '#selectAccountTaboola',
            '#inputCampaignNameSuffix',
            '#inputBrandingText',
            '#inputUrl',
            '#inputUtmCustom'
        ];
        var elementsMarketing = [
            '#checkboxAutopilot',
            '#inputCpc',
            '.radioBidStrategy',
            '.radioDelivery',
            '#inputBudget',
            '#selectBudgetModel',
            '#inputBudgetDaily',
            '#inputBudgetDailyInfinite'
        ];
        var elementsTargeting = [
            '.checkboxLocation',
            '.checkboxDevice',
            '.checkboxOperatingSystem'
        ];
        var elementsSchedule = [
            '#datetimeStartDate',
            '#datetimeEndDate',
            '#checkboxIgnoreEndDate'
        ];
        var elementsAdGroups = [
            '.hiddenAdGroupId'
        ];

        $(document).ready(function () {

            // Setup our initial progress
            updateAllTabs();

            // Register all our back buttons
            subscribeClickable('.buttonBack', clickBack);

            // Register all our next buttons
            setupValidateSection('#buttonNextAccount', elementsAccount, 1);
            setupValidateSection('#buttonNextMarketing', elementsMarketing, 2);
            setupValidateSection('#buttonNextTargeting', elementsTargeting, 3);
            setupValidateSection('#buttonNextSchedule', elementsSchedule, 4);
            setupValidateSection('#buttonNextAdGroups', elementsAdGroups, 5);
        });

        // Registers a next-button to process section validation
        function setupValidateSection(buttonId, elements, sectionProgress) {
            subscribeClickable(buttonId, function () {
                if (validateSet(validatorWizardCampaignGroup, elements)) {
                    clickNext(sectionProgress);
                }
            });
        }

        // Function for going to the next page
        // This has no functionality to post the form
        function clickNext(thisTabProgress) {
            // Only update progress if we are on the last unlocked page
            if (thisTabProgress == progressIndex && thisTabProgress < maxProgress) {
                progressIndex += 1;
                updateAllTabs();
            }

            // Go to the next tab through tab selector trigger
            $('#selectors li:eq(' + thisTabProgress + ') button').tab('show');
        }

        // Function for going to the previous page
        function clickBack(event) {
            let thisTabProgress = $(event.target).attr('data-thisindex')
            if (thisTabProgress > 1) {
                $('#selectors li:eq(' + (thisTabProgress - 2) + ') button').tab('show');
            }
        }

        // Call this when the progress is updated
        function updateAllTabs() {
            updateTab('#selectorAccount');
            updateTab('#selectorMarketing');
            updateTab('#selectorTargeting');
            updateTab('#selectorSchedule');
            updateTab('#selectorAdGroups');
            updateTab('#selectorOverview');
        }

        // Processes the enabling of a single tab based on the progress
        function updateTab(idSelector) {

            var requiredIndex = $(idSelector).attr('data-progress');
            if (progressIndex >= requiredIndex) {
                $(idSelector).removeAttr('disabled');
            } else {
                $(idSelector).attr('disabled', 'disabled');
            }
        }

        // Validates entire form, returns true if valid
        function validateEntireWizard() {
            // Validate all non-lazy
            if (validateSet(validatorWizardCampaignGroup, elementsAccount) &
                validateSet(validatorWizardCampaignGroup, elementsMarketing) &
                validateSet(validatorWizardCampaignGroup, elementsTargeting) &
                validateSet(validatorWizardCampaignGroup, elementsSchedule) &
                validateSet(validatorWizardCampaignGroup, elementsAdGroups)) {
                return true;
            } else {
                return false;
            }
        }

    </script>

}
